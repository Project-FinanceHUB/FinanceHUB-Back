// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Solicitacao {
  id            String   @id @default(uuid())
  numero        String   @unique
  titulo        String
  origem        String   // CNPJ
  prioridade    String   @default("media") // baixa, media, alta
  status        String   @default("aberto") // aberto, pendente, aguardando_validacao, fechado
  estagio       String   @default("Pendente") // Pendente, Em revisão, Aguardando validação, Fechado
  descricao     String?
  boletoPath    String?  // Caminho do arquivo de boleto
  notaFiscalPath String? // Caminho do arquivo de nota fiscal
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  mensagens     Mensagem[]

  @@index([numero])
  @@index([status])
  @@index([createdAt])
}

model Mensagem {
  id            String   @id @default(uuid())
  solicitacaoId String?
  solicitacao   Solicitacao? @relation(fields: [solicitacaoId], references: [id], onDelete: Cascade)
  direcao       String   // enviada, recebida
  assunto       String
  conteudo      String
  remetente     String
  dataHora      DateTime @default(now())
  lida          Boolean  @default(false)
  anexo         String?

  @@index([solicitacaoId])
  @@index([dataHora])
  @@index([lida])
}

model Company {
  id            String   @id @default(uuid())
  nome          String
  cnpjs         String   // JSON array de CNPJs
  ativo         Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([nome])
}

model User {
  id            String   @id @default(uuid())
  nome          String
  email         String   @unique
  role          String   @default("usuario") // admin, gerente, usuario
  ativo         Boolean  @default(true)
  ultimoLogin   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions      Session[]

  @@index([email])
  @@index([role])
  @@index([ativo])
}

model AuthCode {
  id            String   @id @default(uuid())
  email         String
  code          String   // Código de 6 dígitos
  expiresAt     DateTime
  used          Boolean  @default(false)
  attempts      Int      @default(0)
  createdAt     DateTime @default(now())

  @@index([email])
  @@index([code])
  @@index([expiresAt])
  @@index([used])
}

model Session {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token         String   @unique
  expiresAt     DateTime
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
  lastActivity  DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}
